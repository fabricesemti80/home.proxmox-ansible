---
# ---------------------------------------------------------------------------- #
#                                  Preparation                                 #
# ---------------------------------------------------------------------------- #

# ----------------------------- Set Time & NTP ------------------------------- #
- hosts: all
  become: True
  tasks:
  - name: Set timezone
    timezone:
      name: "{{ ntp_timezone | default('Europe/London') }}"

  roles:
  - chrony

# ------------------------------ Deploy SSH key ------------------------------ #
- hosts: pve01
  become: True
  tasks:
  - name: Deploy SSH public key to Proxmox server
    ansible.posix.authorized_key:
      user: root
      state: present
      key: "{{ lookup('file', playbook_dir + '/files/root_pve_rsa.pub') }}"
      comment: "Ansible automation key"

# ---------------------- Configure networking [optional] --------------------- #
- hosts: pve01
  become: True
  serial: 1
  tags: [networking, bridge]
  tasks:
  - name: Install bridge-utils
    apt:
      name: bridge-utils

  - name: Configure /etc/network/interfaces
    template:
      src: "{{ interfaces_template }}"
      dest: /etc/network/interfaces
    register: _configure_interfaces

  - block:
    - name: Reboot for networking changes
      shell: "sleep 5 && shutdown -r now 'Networking changes found, rebooting'"
      async: 1
      poll: 0

    - name: Wait for server to come back online
      wait_for_connection:
        delay: 30
        timeout: 300
      when: _configure_interfaces is changed

    - name: Wait for Ceph to stabilize
      command: ceph health
      register: _ceph_health
      until: "'HEALTH_OK' in _ceph_health.stdout or 'HEALTH_WARN' in _ceph_health.stdout"
      retries: 20
      delay: 10
      check_mode: no
    when: _configure_interfaces is changed

# ---------------------------------------------------------------------------- #
#                                Deploy Proxmox                                #
# ---------------------------------------------------------------------------- #
- hosts: pve01
  become: True
  gather_facts: True
  vars:
    ansible_command_timeout: 600
    ansible_ssh_timeout: 300
  pre_tasks:
    - name: Ensure CephFS-VM keyring exists (link to admin)
      ansible.builtin.copy:
        remote_src: yes
        src: /etc/pve/priv/ceph.client.admin.keyring
        dest: /etc/pve/priv/ceph.client.cephfs-vm.keyring
        owner: root
        group: root
        mode: '0600'
      failed_when: false
    - name: Create Ceph lib directories
      file:
        path: "{{ item }}"
        state: directory
        owner: ceph
        group: ceph
        mode: 0755
        recurse: yes
      loop:
        - /var/lib/ceph/mon
        - /var/lib/ceph/mgr
        - /var/lib/ceph/mds
        - /var/lib/ceph/osd
        - /var/lib/ceph/bootstrap-osd

    - name: Create Ceph config directory
      file:
        path: /etc/ceph
        state: directory
        owner: ceph
        group: ceph
        mode: 0755
        recurse: no
  roles:
  - lae.proxmox

  post_tasks:
    - name: Ensure Ceph Manager is created
      command: "pveceph mgr create"
      register: _mgr_create
      failed_when: false
      changed_when: "'already exists' not in _mgr_create.stderr"

    - name: Ensure Ceph MDS is created
      command: "pveceph mds create"
      register: _mds_create
      failed_when: false
      changed_when: "'already exists' not in _mds_create.stderr"

    - name: Ensure Ceph Manager service is started and enabled
      systemd:
        name: "ceph-mgr@{{ inventory_hostname_short }}"
        state: started
        enabled: yes

    - name: Ensure Ceph MDS service is started and enabled
      systemd:
        name: "ceph-mds@{{ inventory_hostname_short }}"
        state: started
        enabled: yes

# ---------------------------------------------------------------------------- #
#                                Post-deployment                               #
# ---------------------------------------------------------------------------- #

# -------------------------- Configure Gmail SMTP --------------------------- #
- hosts: pve01
  become: True
  tags: gmail_smtp
  roles:
  - proxmox_gmail_smtp

# ----------------------------- Configure backups ---------------------------- #
- hosts: pve01
  become: True
  tags: backup
  roles:
  - proxmox_backup

# --------------------------- Generate API tokens ---------------------------- #
- hosts: pve01
  become: True
  tags: api_tokens
  roles:
  - proxmox_api_tokens

# ----------------------------- Create resource pools ------------------------- #
- hosts: pve01
  become: True
  tags: pools
  roles:
  - proxmox_pools

# ----------------------------- Configure Keepalived ---------------------------- #
- hosts: pve01
  become: True
  tags: keepalived
  vars:
    proxmox_vip: "10.0.40.15"
  roles:
  - keepalived

# ----------------------------- Deploy Beszel Agent -------------------------- #
- hosts: pve01
  become: True
  tags: beszel_agent
  vars:
    agent_public_key: "{{ lookup('env', 'BESZEL_AGENT_KEY') }}"
  roles:
  - community.beszel.agent
    